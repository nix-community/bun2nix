# Private Registry Template

This template demonstrates how to use bun2nix with private npm registries like
GitHub Packages, GitLab, or private npm registries.

## Overview

When your project depends on packages from private registries, you need to
provide authentication credentials. bun2nix supports two methods for configuring
registry credentials:

1. **bunfig.toml** - Bun's native configuration file
1. **.npmrc** - Standard npm configuration file

## Setup

### Using bunfig.toml

Add your registry scopes to `bunfig.toml`:

```toml
[install]
linker = "isolated"

[install.scopes]
# For simple token authentication
"@myorg" = { url = "https://npm.pkg.github.com", token = "$GITHUB_TOKEN" }

# Or just the URL if tokens are in .npmrc
"@another" = "https://registry.example.com"
```

### Using .npmrc

Add authentication tokens to `.npmrc`:

```
//npm.pkg.github.com/:_authToken=${GITHUB_TOKEN}
//registry.example.com/:_authToken=${MY_TOKEN}
```

**Important:** Never commit actual tokens to version control. Use environment
variables or secrets management.

## Usage in Nix

In your `default.nix`, pass the credential file paths to `fetchBunDeps`:

```nix
{ bun2nix, ... }:
bun2nix.mkDerivation {
  packageJson = ./package.json;
  src = ./.;

  bunDeps = bun2nix.fetchBunDeps {
    bunNix = ./bun.nix;

    # Pass credential files (choose one or both)
    bunfigPath = ./bunfig.toml;  # Optional: for bunfig.toml credentials
    npmrcPath = ./.npmrc;        # Optional: for .npmrc credentials
  };
}
```

## How it Works

1. When `bun2nix` generates `bun.nix`, it extracts the full tarball URLs from
   `bun.lock` for packages from non-default registries.

1. When `fetchBunDeps` evaluates, it:
   - Parses credentials from the provided config files
   - Creates an authenticated `fetchurl` wrapper that adds `Authorization`
     headers for matching registry hosts

1. Packages from default registry (registry.npmjs.org) work without credentials.

## Files in this Template

- `flake.nix` - Nix flake configuration
- `default.nix` - Package derivation showing credential file usage
- `bunfig.toml` - Example Bun configuration with registry scopes
- `package.json` - Project manifest
- `bun.nix` - Auto-generated by bun2nix

## Testing

To test with your own private registry:

1. Update `bunfig.toml` with your registry URL and scope
1. Add a dependency from your private registry to `package.json`
1. Set up authentication (e.g., `export GITHUB_TOKEN=...`)
1. Run `bun install` to update `bun.lock`
1. Run `bun2nix -o bun.nix` to regenerate the nix file
1. Build with `nix build`
